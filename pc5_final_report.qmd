---
title: "PC5"
author: "Anne Johnson, Carly Waldeck, David Roth, Joseph Piini"
format: html
editor: visual
embed-resources: true
code-tools: true
warning: FALSE
code-fold: TRUE
---

```{r}
library(tidyverse)
library(gganimate)
library(gt)
library(kableExtra)
```

## Introduction

**Research Question**

Over the course of this project, our groups hopes to answer the following question:

*Is there an association between gross domestic product per capita and food consumption?*

**Background**

We hypothesize that there will be a positive linear relationship with GDP and calories. Foremost, there is a positive linear association with GDP per capita and quality of life. Using this knowledge, that as GDP per capita increases, food abundance would increase, causing the number of calories consumed to also increase. Also, using GDP per capita as a measure of income, as income rises, one is able to afford more. Under the assumption of monotonicity, more is better, and the income effect, one would believe that an increase in overall income would allow people to buy more food (more is better) and have to work less (more time to leisure--eat).(Sands 2024). Furthermore, poorer nations, nations with less GDP per capita suffer more from malnutrition.

#https://www.worldbank.org/en/topic/nutrition/overview

**Summary of Data**

Our team will explore two datasets in our analysis: Gross domestic product (GDP) per capita and food supply.

GDP per capita provides a measure of a country's total economic output, divided by the nation's population. The variable is adjusted for inflation by fixing prices to 2017 dollars, and measured in Purchasing Power Parity (PPP) dollars. PPP dollars offer a virtual currency used to facilitate international economic comparisons. The [dataset](https://www.gapminder.org/data/documentation/gd001/) contains observations for 195 countries, providing estimates spanning from 1800 to 2100.

The [food supply dataset](https://www.fao.org/faostat/en/#home), sourced from the United Nation's Food and Agriculture Organization, provides insight into a country's food security and nutritional status. The dataset offers annual observations of a country's food supply by measuring kilocalories per person per day. The dataset contains observations for 179 countries, spanning from 1961 to 2018.

## Data Cleaning

```{r data_cleaning}
# Joining datasets to include one obs. per country/year combination

gdp_longer <- gdp |>
  mutate(across(.cols = !country,
                .fns = ~ case_when(str_detect(.x, "k") ~ as.numeric(str_remove(.x, "k")) * 1000, TRUE ~ as.numeric(.x)))) |>
  pivot_longer(cols = !country,
               names_to = "year")

food_supply_longer <- food |>
  mutate(across(.cols = !country,
                .fns = ~as.numeric(.x))) |>
  pivot_longer(cols = !country,
               names_to = "year")

data_joined <- gdp_longer |>
  inner_join(food_supply_longer, # only include matching rows
             join_by(country, year)) |>
  rename(gdp_pcap = "value.x",
         food_supply = "value.y") |>
  drop_na() |>
  mutate(year = as_factor(str_extract(year, pattern = "[:digit:]{1,}")),
         country = as_factor(country))

```

**Data Cleaning Process**

The data on food consumption contains 16 fewer countries than the data on GDP per capita. Thus, when combining the data sets, we did not include those 16 countries. Additionally, the data on GDP per capita spans from 1800 to 2100. However, the data on food consumption spans from 1961 to 2018. So, to make sure the years for the data consistent, we only data from GDP per capita from 1961 to 2018. Finally, there are several observations that did not have data on the kilocalories consumed. So, we cleaned our data to only include the years where there was data.

# what about making numbers into 1000s (we did that no?)

*Data Cleaning Potential Impact*

Since we did not include every country in the GDP per capita data, are analysis may be limited. #by what? Furthermore, we only include years for which we had data from both the GDP per capita and food consumption data set. #not too sure what we say here...

## Modeling the Relationship between GDP per Capita and Food Consumption in Kilocalories

```{r load-data}
# load in data
food <- read_csv("food_supply_kilocalories_per_person_and_day.csv")
gdp <- read_csv("gdp_pcap.csv")
```

# Question why did we use data set food, when we already have the cleaned data up above...

```{r}
# clean data then take mean of data from 2012-2018 so we have one x and one y value for each country

food_summary <- food |>
  select("country", "2012", "2013", "2014", "2015",
         "2016", "2017", "2018") |>
  mutate(avg_food = rowMeans(across(`2012`:`2018`), na.rm = TRUE))|> 
  drop_na() |>
  select(country, avg_food)

gdp_summary <- gdp |>
  select(country, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`) |>
  mutate(across(`2012`:`2018`, ~ {
    ifelse(str_detect(.x, "k$"),
           as.numeric(str_remove(.x, "k")) * 1000,
           as.numeric(.x)
    )
  })) |>
  mutate(average_gdp = rowMeans(across(`2012`:`2018`), na.rm = TRUE)) |>
  select(country, average_gdp)

food_gdp <- left_join(food_summary, gdp_summary, by = "country")
```

```{r}
# Joining datasets to include one obs. per country/year combination

gdp_longer <- gdp |>
  mutate(across(.cols = !country,
                .fns = ~ case_when(str_detect(.x, "k") ~ as.numeric(str_remove(.x, "k")) * 1000, TRUE ~ as.numeric(.x)))) |>
  pivot_longer(cols = !country,
               names_to = "year")

food_supply_longer <- food |>
  mutate(across(.cols = !country,
                .fns = ~as.numeric(.x))) |>
  pivot_longer(cols = !country,
               names_to = "year")

data_joined <- gdp_longer |>
  inner_join(food_supply_longer, # only include matching rows
             join_by(country, year)) |>
  rename(gdp_pcap = "value.x",
         food_supply = "value.y") |>
  drop_na() |>
  mutate(year = as_factor(str_extract(year, pattern = "[:digit:]{1,}")),
         country = as_factor(country))

```

## Modeling the Data Relationship Between Food Consumption and GDP per Capita

```{r, results='hide'}
## run linear regression
model <- lm(log(avg_food) ~ log(average_gdp), data = food_gdp)
summary(model)
```

In order to better observe and quantify the relationship between food consumption and GDP per capita, a linear regression model was fit. The relationship between the original variables was not linear, so a logarithmic transformation was applied to both.

The following equation represents the fitted regression model, where $\widehat{food_i}$ represents the predicted average food consumption (kcal/person/day) and $GDP_i$ represents average GDP per capita (USD).

$$\log{(\widehat{food}_i)} = 6.895 + 0.1125\log{(GDP_i)}$$

A 1% increase in average GDP per capita is associated with approximately a 0.1125% increase in average food consumption.

The expected natural logarithm of average food consumption is 6.895 when the natural logarithm of average GDP per capita is zero. On a non-logarithmic scale, this corresponds to an expected average food supply of 987.3 kcal/person/day when average GDP per capita is \$1 USD.

## Cross-Validation

```{r}
# Separate into folds
set.seed(123)
k <- 10
n <- nrow(food_gdp)

food_gdp_rand <- food_gdp |> 
  mutate(fold_random = sample(rep_len(1:k, length.out = n),
                              size = n))

# k-fold function
cross <- function(x, food_gdp) {
  fold_dat <- food_gdp |> 
    filter(fold_random == x)
  train_dat <- food_gdp |> 
    filter(fold_random != x)
  
  model <- lm(log(avg_food) ~ log(average_gdp), data = train_dat)
  
  # generate predictions for the held-out fold data
  fold_preds <- predict(model, newdata = fold_dat)
  
  cv_r2 <- var(fold_preds, na.rm = TRUE)/var(log(fold_dat$avg_food), na.rm = TRUE)
  
}


r_sq_k_fold <- map_dbl(.x = 1:k,
                       .f = ~cross(.x, food_gdp_rand))

avg_rsq <- mean(r_sq_k_fold)
```

```{r}
# Plot
as.data.frame(r_sq_k_fold) |>
  arrange(r_sq_k_fold) |> 
  ggplot(aes(y = r_sq_k_fold,
             x = 1:10)
         ) +
  geom_col() +
  geom_hline(aes(yintercept = mean(r_sq_k_fold)), 
             color = "red") +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())+
  labs(title = "Cross Validation R²",
       y ="R²", x = "", 
       caption = "The red line is the average R² from the Cross Validation tests.")
```

...

## Conclusion

...
